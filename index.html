<!doctype html>
<html>
<head>
  <title>reason.js</title>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='keywords' content='reason.js, reason, javascript, dependent types, formal verification, proofs'>
  <meta name='description' content='A library for dependent types in Javascript, with the power to formally verify properties on typed objects.'>
  <link rel='icon' type='image/x-icon' href='data:image/x-icon;base64,'>
  <style>
    @font-face {
      font-family: 'sketchblock';
      src: url('fonts/SketchBlock.woff') format('woff2'),
           url('fonts/SketchBlock.woff2') format('woff2');
      font-weight: normal;
      font-style: normal
    }
    @font-face {
      font-family: 'crimson';
      src: url('fonts/Crimson.woff')  format('woff'),
           url('fonts/Crimson.woff2') format('woff2');
      font-weight: normal;
      font-style: normal
    }
    @font-face {
      font-family: 'crimson';
      src: url('fonts/Crimson-Bold.woff')  format('woff'),
           url('fonts/Crimson-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal
    }
    @font-face {
      font-family: 'crimson';
      src: url('fonts/Crimson-Italic.woff')  format('woff'),
           url('fonts/Crimson-Italic.woff2') format('woff2');
      font-weight: normal;
      font-style: italic
    }
    @font-face {
      font-family: 'univers';
      src: url('fonts/UniversNextTypewriter.woff')  format('woff'),
           url('fonts/UniversNextTypewriter.woff2') format('woff2');
      font-weight: normal;
      font-style: normal
    }
    body {
      margin: 4vh 25vw 0 15vw;
      background: url(images/bg.png);
      min-height: calc(100vh - 8vmin);
      color: #fff;
      font-size: 18px;
      border-top: 10px solid white }
    section {
      clear: right;
      margin-bottom: 14vmin }
    section:first-child p {
      font-variant: small-caps;
      padding: 0 3rem }
    h1 {
      font-family: 'sketchblock';
      font-weight: normal;
      margin: 2vmin 4vmin 5vmin 0;
      font-size: 4rem }
    h2 {
      font-family: 'crimson';
      font-size: 2.4rem;
      margin: 0 4vmin 3vmin 0 }
    p {
      font-family: 'crimson';
      font-size: 1.6rem;
      margin: 3vmin 0 4vmin 0;
      line-height: 2.4rem;
      text-align: justify }
    aside {
      margin: 0 -15vw 4vh 4vw;
      width:  35vw;
      height: 25vw;
      float: right;
     }
    iframe {
      width: 100%;
      height: 100%;
      border: 0 }
    .cut-in {
      margin: 4vh -15vw 27vh 4vw;
      --top: 15rem;
      --width: 35vw;
      --height: 30rem;
      --bottom: 100vh;

      width:  var(--width);
      height: var(--height);
      transform: translate(0, var(--top));
      shape-outside: polygon(0 var(--top), var(--width) var(--top), var(--width) var(--bottom), 0 var(--bottom));
      clip-path: polygon(0 0, var(--width) 0, var(--width) calc(var(--bottom) - var(--top)), 0 calc(var(--bottom) - var(--top)))
    }
    a {}
    strong {}
    em {}
    code {
      font-family: 'univers';
      font-variant-ligatures: none;
      font-size: 1.3rem;
      background: #fff2;
      --border: .4rem;
      padding: var(--border);
      margin: calc(- var(--border)) }
    blockquote {
      display: flex;
      background: #fff2;
      font-family: 'univers';
      font-variant-ligatures: none;
      padding: .4rem }
  </style>
  <script src='reason.js' defer></script>
  <script src='machine.js'></script>
</head>
<body>
  <main>
    <section>
      <h1>reason.js</h1>
      <p>A library for dependent types in Javascript, with the power to formally verify properties on typed objects.</p>
    </section>
  </main>
  <template id='editor'
    ><html>
      <head>
        <style>
          @font-face {
            font-family: 'univers';
            src: url('fonts/UniversNextTypewriter.woff')  format('woff'),
                 url('fonts/UniversNextTypewriter.woff2') format('woff2');
            font-weight: normal;
            font-style: normal
          }
          html {
            margin: 0;
            --x: 10px;
            font-size: 16px }
          body {
            margin: 1px 2px 1px 1px;
            overflow: hidden;
            background: #0008;
            color: #fff }
          main {
            display: grid;
            width: 100%;
            grid-gap: 1px }
          #source, #log {
            width: calc(100vw - 2 * var(--x) - 2px);
            height: calc(50vh - 2 * var(--x) - 1.5px);
            box-shadow: 0 0 0 1px #666;
            padding: var(--x);
            line-height: 1.2rem }
          #source {
            border: 0;
            margin: 0;
            outline: 0;
            background: transparent;
            min-height: 5vh;
            max-height: 85vh;
            resize: vertical;
            font-size: inherit;
            font-family: 'univers';
            font-variant-ligatures: none;
            color: #fff }
          #log {
            font-family: 'univers';
            font-variant-ligatures: none;
            overflow-y: auto;
            word-break: break-all }
          button {
            position: absolute;
            top: 10px;
            right: 10px }
          hr {
            border: 0;
            height: 0;
            border-top: 1px solid #444 }
        </style>
        <script src='reason.js' defer></script>
      </head>
      <body>
        <main>
          <textarea id='source'>[]</textarea>
          <div id='log'></div>
        </main>
        <button id='run'>Run</button>
        <script type="text/javascript" defer>
          let sourceTextbox = document.getElementById('source'),
              logDiv = document.getElementById('log'),
              runButton = document.getElementById('run');
              adjustHeight = () => logDiv.style.height = window.innerHeight - 23 - sourceTextbox.offsetHeight + 'px',
              log = (...args) => {
                logDiv.childNodes.length && logDiv.appendChild(document.createElement('hr'));
                logDiv.appendChild(document.createTextNode(args.join(' '))) };
          new MutationObserver(adjustHeight).observe(sourceTextbox, { attributes: true, attributeFilter: [ "style" ] });
          runButton.addEventListener('click', () => eval(
            `(async () => {` +
            `  let R = Reason();` +
            `  ${sourceTextbox.value}` +
            `})()` +
            `  .catch(e => log(e.message))` +
            `  .then(() => document.getElementById('log').scrollTo(0, 1e6))`
          ))
        </script>
      </body>
    </html
  ></template>
  <template id='section'
    ><section>
      <aside><iframe></iframe></aside>
    </section
  ></template>
  <script>
// Page state
// [[], [].join('\n'), true]
var app = new $.Machine({
  sections: [
    [['#Are you sure about that?#',

      `A sentiment expressed so well by the great Jonathan Cena, uncertainty is something that touches all of us. Contrary to what some may think, a computer program won't help you separate reality from fiction when it comes to affairs of heart, or of society at large, but a little boost of confidence in regards to things doing what they say on the label wouldn't go astray in this fast-paced modern world. I'm not about to tell you dependent types or formal verification will spell the end of test driven development, nor that my little summer project to write a programming language in Javascript is fit for use in anything other than your own fun side projects. But if someone told you that there was a system within which the properties of a program written on the label were mathematically guaranteed to be true, that would make you want to see for yourself, wouldn't it?`,

      `So without further ado, I would like to introduce reason.js, an interpreter for my language, which has some nifty features I'm kind of proud of, as well as some others that are still works in progress. I have also included little Javascript sandboxes in each section so you can experiment with using features for yourself. Edit the source code in the upper half, then click run to see the results in the lower half. You can also move the divider up and down (the handle is on the right). Try it!`
    ], [
      `let identity = new R.Def(`,
      `  "id", "({t}, x => x) : {T : Type} -> T -> T"`,
      `);`,
      ``,
      `await R.ready;`,
      ``,
      `log(identity.print);`,
      `log(identity.type.print())`
    ].join('\n'), true
    ], [[
        `#Installation#`,
        `It's in the books to publish reason.js to npm, but for now you can simply clone master:`,
        `>$ git clone --depth 1 -b master https://github.com/ajhamwood/reason`,
        `If you now include the file \`\`reason.js\`\` in the root directory in your project, you will be able to access the interpreter by calling \`\`const R = Reason()\`\`.`
    ], [].join('\n'), false
    ], [[
      `#Objection!#`,
      ``,
      `The workhorse of reason.js are the methods \`\`Sig\`\`, \`\`Def\`\` and \`\`Data\`\` on the object you just initialised. They can be used to initialise types, type constructors, type signatures, and functions, which are all you need to access the full power of dependent types.`,
      ``,
      `Let's start off with \`\`Def\`\`, which creates term definitions. The identity function for example can be encoded likewise:`,
      ``,
      `>let identity = new R.Def("id", "(t, x => x) : (T : Type) -> T -> T");`,
      ``,
      `Let's break that down. The string argument encodes the term that will be interpreted, checked that it conforms to the typing rules of the language, and then attached to the Javascript class being instantiated. The actual syntax will be described later on; for now, we will focus on the Javascript. Although this example will return near-instantaneously, some type checks may be more computationally intensive to run. To deal with this, the \`\`identity\`\` object initially has only four properties of note: \`\`appliedTerms\`\`, \`\`toString\`\`, and \`\`ready\`\` and \`\`name\`\` (\`\`length\`\` is a property on all JS functions). Here we are interested in that last one: it returns a promise containing the typechecked object. So, if you run the following code within an \`\`async\`\` function, the results will be available immediately afterwards:`,
      ``,
      `>let identity = await new R.Def("id", "(t, x => x) : (T : Type) -> T -> T").ready;`,
      ``,
      `For convenience, the reason.js object also has this property, so you can call \`\`await R.ready;\`\` to pause at any moment until the typecheck has completed.`,
      ``,
      `This time, we get four additional properties: \`\`type\`\`, \`\`term\`\`, \`\`print\`\`, and \`\`result\`\`, and we are now ready to consider the API on term definitions as a whole.`
    ], [
      `let identity = new R.Def(`,
      `  "id", "(t, x => x) : (T : Type) -> T -> T"`,
      `);`,
      ``,
      `log(Object.getOwnPropertyNames(identity));`,
      ``,
      `await R.ready;`,
      ``,
      `log(Object.getOwnPropertyNames(identity))`
    ].join('\n'), true
    ], [[
      `#The term definition API#`,
      ``,
      `First, let's look at the immediately available properties.`,
      ``,
      `\`\`ready\`\` we have already seen. It returns a \`\`Promise\`\` containing the asynchronously-available term object.`,
      ``,
      `\`\`name\`\` is an easy one: this is the identifier the term has been declared as. In the above example, its value would be \`\`"id"\`\`.`,
      ``,
      `In our example, \`\`appliedTerms\`\` would return an empty list. However as the name suggests, if you were to //apply// terms to a typechecked function, the results would be available here. We could even apply id to itself, like so:`,
      ``,
      `>let idType = new R.Def("idType", "((T : Type) -> T -> T) : Type");`,
      ``,
      `>let idid = identity(idType, identity);`,
      ``,
      `You would then find \`\`appliedTerms\`\` to be equal to \`\`[ idType, identity ]\`\`. However, if you used the in-page sandbox for this section, the log would instead display \`\`<idT>,<id>\`\`. This is because the \`\`toString\`\` function on terms returns the supplied term name within angle brackets by default. In the section on converters, we will cover how to define your own string coercion function, but for now you can consider it as almost the same as \`\`name\`\`.`,
      ``,
      `Now for the asynchronously available properties.`,
      ``,
      `\`\`print\`\` returns a string representing the term. It should be quite similar to the expression you supplied on instantiation, but the variables will be renamed to generic x's, y's and z's. (There may still be some printing bugs for me to squash, please report it if you find one!)`,
      ``,
      `\`\`term\`\` and \`\`type\`\` contain the internal representation of the typechecked term and type respectively. You may not find much use for them yet, but it might be interesting to execute their \`\`toString\`\` methods!`,
      ``,
      `Finally, \`\`result\`\` contains the result of evaluating the term. Comparing \`\`idid.print\`\` and \`\`idid.result.print()\`\` will illustrate the work the typechecker actually performed on the supplied term.`
    ], [
      `let identity = new R.Def(`,
      `      "id", "(t, x => x) : (T : Type) -> T -> T"`,
      `    ),`,
      `    idType = await new R.Def(`,
      `      "idT", "((T : Type) -> T -> T) : Type"`,
      `    ).ready,`,
      `    idid = await identity(idType, identity).ready;`,
      ``,
      `log(idid.result.print())`
    ].join('\n'), true]
  ]
});

// Events
$.targets({
  load () { app.emit('load-editors') },
  app: { 'load-editors' () {
    this.sections.forEach(([ps, source, cutin]) => {
      let section = $.load('section', 'main')[0][0];
      for (let p of ps) write(p, section);
      if (typeof source === 'string' && source.length) {
        $('iframe', section)[0].srcdoc = $('template#editor')[0].innerHTML.replace(/\[\]/g, source);
        if (cutin) $('aside', section)[0].classList.add('cut-in');
      } else $('aside', section)[0].remove();
    })
  } }
});

// Oh god. Very old markup code I had lying around

function write (raw, section) {
  //  **bold**  //italic//  ``monospaced``  [[link url]]  [[link url|link text]]
  //  >quote (\>no quote)  ␣␣↵line break  ↵↵paragraph  #(#..)header#
  function escape (text) {
    var div = document.createElement("div");
    div.appendChild(document.createTextNode(text));
    return div.innerHTML
  }
  var r = escape(raw), newline = r.indexOf("\r\n") !== -1 ? "\r\n" : r.indexOf("\n") !== -1 ? "\n" : "";
  r = r
    .replace(new RegExp(" + " + newline, "g"), "<br />" + newline)
    .replace(/^(#{1,5})([^#]*)#/, function ($0, $1, $2) {
      var l = $1.length + 1;
      if (l === 2) {
        var slug = encodeURI( $2.replace(/\s+/g, "-").replace(/\*\*(.*)\*\*/g, "$1").replace(/``(.*)``/g, "$1")
          .replace(/^/," ").replace(/([^:])\/\/(((?!\/\/)[\s\S])*)\/\//gm, "$2").replace(/^ /,"")
          .replace(/\[\[([^\]|]*)\]\]/g, "$1").replace(/\[\[([^|]*)\|([^\]]*)\]\]/g, "$2")
          .replace(/[^\w\-.~!$&'()*+,;=:@]/g, "").toLowerCase() );
        return "<header><a class='hashlink' id='" + slug + "' href='#" + slug + "'></a><h2>" + $2 +
          "</h2></header>"
      } else return "<h" + l + ">" + $2 + "</h" + l + ">"
    })
    .replace(/``([^`]*)``/g, "<code>$1</code>")
    .replace(/\*\*([^*]*)\*\*/g, "<strong>$1</strong>")
    .replace(/^/," ").replace(/([^:])\/\/(((?!\/\/)[\s\S])*)\/\//gm, "$1<em>$2</em>").replace(/^ /,"")
    .replace(/\[\[([^\]|]*)\]\]/g, function ($0, $1) { return "<a href='" + $1.replace(/'/g, "&apos;") + "'>" + $1 + "</a>" })
    .replace(/\[\[([^|]*)\|([^\]]*)\]\]/g, function ($0, $1, $2) { return "<a href='" + $1.replace(/'/g, "&apos;") + "'>" + $2 + "</a>" });
  for (var p = (newline === "" ? [r] : r.split(newline + newline)), i = 0; i < p.length; i++) {
    p[i] = p[i]
      .replace(/^&gt;(.*)/g, "<blockquote>$1</blockquote>").replace(/^\\&gt;/g, "&gt;")
      .replace(/^( +)/g, function (match) { return match.replace(/\s/g,"&nbsp;") });
    p[i] = p[i].replace(/([\s\S]+)/g, "<p>$1</p>")
  }
  section.innerHTML += p.join(newline);
}

$.queries({})
  </script>
  <noscript><h6>Only viewable with JavaScript enabled.</h6></noscript>
</body>
</html>
